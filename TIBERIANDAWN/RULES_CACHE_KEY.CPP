#include <string>

#include "rules_cache_key.h"
#include "rules_ini_enhancements.h"
#include "rules_ini_game.h"
#include "strings.h"

static const CacheKey HASH_SEED = 5381ul;

CacheKey Build_Rule_Key(const char* section, const char* ruleName)
{
	auto keyString = Allocate_String(MAX_KEY_LENGTH);
	auto upperSection = Convert_String_To_Upper_Case(section);
	auto upperRuleName = Convert_String_To_Upper_Case(ruleName);

	sprintf(keyString, "%s__%s", upperSection, upperRuleName);

	auto hash = HASH_SEED;
	auto stringChar = 0;

	auto iterator = keyString;

	while (stringChar = *iterator++)
	{
		hash = ((hash << 5) + hash) + stringChar;
	}

	delete keyString;
	delete upperSection;
	delete upperRuleName;

	return hash;
}

/**
 *  Cache calculated constant keys - only cache entries which require a high 
 *  performance get call should be listed here. (game loop rules etc.)
 **/

const CacheKey MAX_BUILD_DISTANCE_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, MAX_BUILD_DISTANCE_RULE);
const CacheKey CREDITS_PER_TIBERIUM_SCOOP_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, CREDITS_PER_TIBERIUM_SCOOP_RULE);
const CacheKey MAX_HARVESTER_CAPACITY_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, MAX_HARVESTER_CAPACITY_RULE);
const CacheKey UNIT_REPAIR_STEP_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, UNIT_REPAIR_STEP_RULE);
const CacheKey AIRCRAFT_REPAIR_STEP_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, AIRCRAFT_REPAIR_STEP_RULE);

const CacheKey AIRCRAFT_REPAIR_FACTOR_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, AIRCRAFT_REPAIR_FACTOR_RULE);
const CacheKey RENAME_TECH_CENTER_TO_PRISON_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, RENAME_TECH_CENTER_TO_PRISON_RULE);
const CacheKey SURVIVORS_FROM_BUILDINGS_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, SURVIVORS_FROM_BUILDINGS_RULE);
const CacheKey ALLOW_BUILDING_BESIDE_WALLS_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, ALLOW_BUILDING_BESIDE_WALLS_RULE);
const CacheKey PREVENT_BUILDING_IN_SHROUD_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, PREVENT_BUILDING_IN_SHROUD_RULE);
const CacheKey HIDE_E3_FROM_GDI_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, HIDE_E3_FROM_GDI_RULE);
const CacheKey HIDE_MSAM_FROM_GDI_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, HIDE_MSAM_FROM_GDI_RULE);
const CacheKey HIDE_APC_FROM_NOD_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, HIDE_APC_FROM_NOD_RULE);
const CacheKey HIDE_TMPL_FROM_GDI_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, HIDE_TMPL_FROM_GDI_RULE);
const CacheKey HIDE_OBLI_FROM_GDI_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, HIDE_OBLI_FROM_GDI_RULE);
const CacheKey HIDE_MSAM_FROM_NOD_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, HIDE_MSAM_FROM_NOD_RULE);
const CacheKey HIDE_ADV_COMM_FROM_NOD_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, HIDE_ADV_COMM_FROM_NOD_RULE);
const CacheKey ALLOW_NOD_TO_BUILD_NUK2_EARLY_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, ALLOW_NOD_TO_BUILD_NUK2_EARLY_RULE);
const CacheKey HIDE_HELIPAD_FROM_NOD_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, HIDE_HELIPAD_FROM_NOD_RULE);
const CacheKey HIDE_SBAG_FROM_GDI_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, HIDE_SBAG_FROM_GDI_RULE);
const CacheKey SET_GDI_SCENARIO_2_BUILD_LEVEL_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, SET_GDI_SCENARIO_2_BUILD_LEVEL_RULE);
const CacheKey ALLOW_BUILDING_ALL_FOR_HOUSE_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, ALLOW_BUILDING_ALL_FOR_HOUSE_RULE);
const CacheKey ONLY_GDI_CAN_USE_ION_CANNON_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, ONLY_GDI_CAN_USE_ION_CANNON_RULE);
const CacheKey ONE_TIME_NUKE_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, ONE_TIME_NUKE_RULE);
const CacheKey ONLY_ALLOW_NUKE_IF_PARTS_COLLECTED_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, ONLY_ALLOW_NUKE_IF_PARTS_COLLECTED_RULE);
const CacheKey TIBERIUM_INFANTRY_DAMAGE_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, TIBERIUM_INFANTRY_DAMAGE_RULE);
const CacheKey TIBERIUM_GROWTH_RATE_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, TIBERIUM_GROWTH_RATE_RULE);
const CacheKey TIBERIUM_SPREAD_RATE_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, TIBERIUM_SPREAD_RATE_RULE);
const CacheKey SPEEDY_BUILDS_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, SPEEDY_BUILDS_RULE);
const CacheKey ATTACKER_ADVANTAGE_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, ATTACKER_ADVANTAGE_RULE);
const CacheKey DEFEND_AGAINST_FRIENDLY_FIRE_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, DEFEND_AGAINST_FRIENDLY_FIRE_RULE);
const CacheKey TARGET_TREES_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, TARGET_TREES_RULE);
const CacheKey MCV_REDEPLOY_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, MCV_REDEPLOY_RULE);
const CacheKey VISCEROIDS_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, VISCEROIDS_RULE);
const CacheKey UNITS_INDESTRUCTIBLE_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, UNITS_INDESTRUCTIBLE_RULE);
const CacheKey THREE_POINT_TURNS_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, THREE_POINT_TURNS_RULE);
const CacheKey TIBERIUM_GROWS_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, TIBERIUM_GROWS_RULE);
const CacheKey TIBERIUM_SPREADS_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, TIBERIUM_SPREADS_RULE);
const CacheKey SLOW_TIBERIUM_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, SLOW_TIBERIUM_RULE);
const CacheKey SHOW_BIBS_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, SHOW_BIBS_RULE);
const CacheKey AUTO_SCATTER_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, AUTO_SCATTER_RULE);
const CacheKey NAME_CIVILIAN_BUILDINGS_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, NAME_CIVILIAN_BUILDINGS_RULE);
const CacheKey CAN_BUY_HELIPAD_ONLY_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, CAN_BUY_HELIPAD_ONLY_RULE);
const CacheKey UNIT_REPAIR_FACTOR_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, UNIT_REPAIR_FACTOR_RULE);
const CacheKey DEBUG_LOGGING_RULE_KEY = Build_Rule_Key(GAME_RULES_SECTION_NAME, DEBUG_LOGGING_RULE);

const CacheKey RALLY_POINTS_RULE_KEY = Build_Rule_Key(ENHANCEMENTS_RULES_SECTION_NAME, RALLY_POINTS_RULE);

